name: Compile and Package Demo Pack

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Demo Pack
      uses: actions/checkout@v4
      with:
        path: MonstrosityDemoPack # ðŸ‘ˆ Lo bajamos en una subcarpeta para controlar la estructura

    - name: Checkout Framework (Dependency)
      uses: actions/checkout@v4
      with:
        repository: javcombita/MonstrosityFramework # ðŸ‘ˆ Reemplaza con tu usuario/repo real del Framework
        path: MonstrosityFramework # ðŸ‘ˆ Lo bajamos al lado, para que la referencia relative funcione
        ref: main # O 'master', asegÃºrate de que coincida con tu rama principal

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 6.0.x

    - name: Restore dependencies
      # Ahora la ruta es relativa a donde clonamos el Demo
      run: dotnet restore MonstrosityDemoPack/MonstrosityDemoPack/MonstrosityDemoPack.csproj

    - name: Build C# Mod (Release Mode)
      run: dotnet build MonstrosityDemoPack/MonstrosityDemoPack/MonstrosityDemoPack.csproj --configuration Release --no-restore /p:EnableModDeploy=false

    - name: Create Release Structure
      run: |
        mkdir -p release/MonstrosityDemoPack
        mkdir -p "release/[CP] MonstrosityDemoPack"

    - name: Package C# Mod (MonstrosityDemoPack)
      run: |
        echo "ðŸ“¦ Packaging C# Mod..."
        # Ajustamos las rutas base porque ahora todo estÃ¡ dentro de 'MonstrosityDemoPack/'
        BASE_DIR="MonstrosityDemoPack/MonstrosityDemoPack"
        
        cp $BASE_DIR/bin/Release/net6.0/MonstrosityDemoPack.dll release/MonstrosityDemoPack/
        cp $BASE_DIR/manifest.json release/MonstrosityDemoPack/
        
        if [ -d "$BASE_DIR/assets" ]; then
          cp -r $BASE_DIR/assets release/MonstrosityDemoPack/
        fi
        
        if [ -d "$BASE_DIR/i18n" ]; then
          cp -r $BASE_DIR/i18n release/MonstrosityDemoPack/
        fi

    - name: Package Content Pack ([CP] MonstrosityDemoPack)
      run: |
        echo "ðŸ“¦ Packaging Content Pack..."
        # Ruta al Content Pack dentro del checkout
        CP_DIR="MonstrosityDemoPack/[CP] MonstrosityDemoPack"
        
        cp -r "$CP_DIR"/* "release/[CP] MonstrosityDemoPack/"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MonstrosityDemoPack_Bundle
        path: release/